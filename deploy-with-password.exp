#!/usr/bin/expect -f
#
# Automated deployment script with password authentication
# This script will SSH to production and run all deployment steps
#

set timeout 300
set password "Cluster1!"

spawn ssh pazpaz@5.161.241.81

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "$ " {
        send "cd /opt/pazpaz\r"
    }
}

expect "$ "
send "echo 'ðŸš€ Starting AI Agent Deployment'\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo 'ðŸ“¦ Step 1: Creating database backup...'\r"

expect "$ "
send "BACKUP_DIR=\"/opt/pazpaz/backups/ai-deployment-\$(date +%Y%m%d-%H%M%S)\"\r"

expect "$ "
send "mkdir -p \$BACKUP_DIR\r"

expect "$ "
send "echo \"Backup directory: \$BACKUP_DIR\"\r"

expect "$ "
send "docker exec pazpaz-db pg_dump -U pazpaz -F c -b -v -f /tmp/db_backup.dump pazpaz 2>&1\r"

expect "$ "
send "docker cp pazpaz-db:/tmp/db_backup.dump \$BACKUP_DIR/\r"

expect "$ "
send "docker exec pazpaz-db rm /tmp/db_backup.dump\r"

expect "$ "
send "echo 'âœ… Backup complete'\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo 'ðŸ“¥ Step 2: Pulling latest code...'\r"

expect "$ "
send "git pull origin main\r"

expect "$ "
send "echo 'âœ… Code updated'\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo 'ðŸ”§ Step 3: Adding AI configuration...'\r"

expect "$ "
send "if grep -q '^COHERE_API_KEY=' .env.production 2>/dev/null; then echo 'âœ… AI config exists'; else cat >> .env.production << 'ENVEOF'\n\n# AI Agent Configuration\nCOHERE_API_KEY=32LXdDIoANDKxNPoMl1eYCamxZUf54wOYPBFEgnf\nCOHERE_EMBED_MODEL=embed-v4.0\nCOHERE_CHAT_MODEL=command-a-03-2025\nAI_EMBEDDING_PROVIDER=cohere\nAI_CHAT_PROVIDER=cohere\nAI_AGENT_ENABLED=true\nAI_AGENT_MAX_QUERIES_PER_HOUR=30\nAI_AGENT_MAX_CONTEXT_TOKENS=8000\nAI_AGENT_MAX_OUTPUT_TOKENS=4000\nENVEOF\necho 'âœ… AI config added'; fi\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo 'ðŸ—„ï¸ Step 4: Running database migrations...'\r"

expect "$ "
send "docker exec pazpaz-api bash -c 'cd /app && PYTHONPATH=/app/src uv run --no-sync python -m alembic upgrade head'\r"

expect "$ "
send "echo 'âœ… Migrations complete'\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo 'âœ… Step 5: Verifying pgvector...'\r"

expect "$ "
send "docker exec pazpaz-db psql -U pazpaz -d pazpaz -c \"SELECT extname, extversion FROM pg_extension WHERE extname = 'vector';\"\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo 'ðŸ“Š Step 6: Verifying vector tables...'\r"

expect "$ "
send "docker exec pazpaz-db psql -U pazpaz -d pazpaz -c '\\dt *vectors'\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo 'ðŸ”„ Step 7: Restarting services...'\r"

expect "$ "
send "docker compose -f docker-compose.prod.yml --env-file .env.production restart\r"

expect "$ "
send "echo 'âœ… Services restarted'\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo 'â³ Waiting for services...'\r"

expect "$ "
send "sleep 15\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo 'ðŸ¥ Step 8: Health check...'\r"

expect "$ "
send "docker compose -f docker-compose.prod.yml --env-file .env.production exec -T api curl -s http://localhost:8000/health | head -20\r"

expect "$ "
send "echo ''\r"

expect "$ "
send "echo '================================================'\r"

expect "$ "
send "echo 'ðŸŽ‰ DEPLOYMENT COMPLETED!'\r"

expect "$ "
send "echo '================================================'\r"

expect "$ "
send "echo 'Backup location: '\$BACKUP_DIR\r"

expect "$ "
send "exit\r"

expect eof
