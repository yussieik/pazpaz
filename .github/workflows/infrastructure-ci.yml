name: Infrastructure CI

on:
  push:
    branches: [ main ]
    paths:
      - 'docker-compose*.yml'
      - 'nginx/**'
      - 'scripts/**'
      - '.env.production.example'
      - '.env.example'
      - '.github/workflows/infrastructure-ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'docker-compose*.yml'
      - 'nginx/**'
      - 'scripts/**'
      - '.env.production.example'
      - '.env.example'
      - '.github/workflows/infrastructure-ci.yml'
  workflow_dispatch:

jobs:
  validate:
    name: Validate Infrastructure
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install validation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck nginx

          # Install Docker Compose
          sudo curl -L "https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose

      - name: Create test environment file
        run: |
          cat > .env.production << 'EOF'
          # Test environment for CI validation
          GITHUB_REPOSITORY=testuser/pazpaz
          IMAGE_TAG=test
          VERSION=test
          POSTGRES_PASSWORD=test_postgres_password_32_chars_long_for_ci
          REDIS_PASSWORD=test_redis_password_32_chars_long_for_ci_test
          S3_ACCESS_KEY=test_access_key_20chr
          S3_SECRET_KEY=test_secret_key_40_characters_long_for_ci
          S3_BUCKET_NAME=pazpaz-attachments
          S3_REGION=us-east-1
          MINIO_ENCRYPTION_KEY=dGVzdF9lbmNyeXB0aW9uX2tleV9mb3JfY2lfZXhhY3RseTMyYnl0ZXM=
          SECRET_KEY=test_secret_key_64_characters_long_for_ci_validation_only_12345
          JWT_SECRET_KEY=test_jwt_secret_32_chars_for_ci
          ENCRYPTION_MASTER_KEY=dGVzdF9lbmNyeXB0aW9uX21hc3Rlcl9rZXlfZm9yX2NpXzMyYnl0ZXM=
          FRONTEND_URL=https://test.pazpaz.com
          ALLOWED_HOSTS=test.pazpaz.com,api.test.pazpaz.com
          CORS_ALLOWED_ORIGINS=
          SMTP_HOST=smtp.test.com
          SMTP_PORT=587
          SMTP_USER=testuser
          SMTP_PASSWORD=test_smtp_password_for_ci
          SMTP_USE_TLS=true
          EMAILS_FROM_EMAIL=noreply@test.pazpaz.com
          SENTRY_DSN=
          LOG_LEVEL=INFO
          WORKERS=4
          MAX_CONNECTIONS=100
          ENABLE_2FA=true
          ENABLE_FILE_UPLOADS=true
          ENABLE_EMAIL_NOTIFICATIONS=true
          ENABLE_VIRUS_SCANNING=true
          DB_SSL_ENABLED=false
          DB_SSL_MODE=prefer
          BACKUP_SCHEDULE="0 2 * * *"
          BACKUP_RETENTION_DAYS=30
          BACKUP_S3_BUCKET=
          BACKUP_S3_ACCESS_KEY=
          BACKUP_S3_SECRET_KEY=
          BACKUP_S3_REGION=us-east-1
          DEPLOYMENT_ENV=test
          DEPLOYMENT_REGION=us-east-1
          DEPLOYMENT_TIMESTAMP=$(date +%s)
          EOF

      - name: Run infrastructure validation
        run: |
          chmod +x scripts/validate-infrastructure.sh
          ./scripts/validate-infrastructure.sh --check=all

      - name: Cleanup
        if: always()
        run: rm -f .env.production

  docker-build-test:
    name: Test Docker Builds
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: ./.github/actions/setup-docker

      - name: Build Nginx image
        uses: docker/build-push-action@v6
        with:
          context: ./nginx
          file: ./nginx/Dockerfile
          tags: pazpaz/nginx:test
          load: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan Nginx image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: pazpaz/nginx:test
          severity: 'HIGH,CRITICAL'
          ignore-unfixed: true

      - name: Check image size
        run: |
          size=$(docker image inspect pazpaz/nginx:test --format='{{.Size}}')
          size_mb=$((size / 1024 / 1024))
          echo "Nginx image size: ${size_mb}MB"

          if [ $size_mb -gt 100 ]; then
            echo "::warning::Nginx image is larger than 100MB (${size_mb}MB)"
          fi

  success:
    name: Infrastructure CI Success
    needs: [validate, docker-build-test]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check job results
        run: |
          if [[ "${{ needs.validate.result }}" != "success" ]]; then
            echo "::error::Validation failed"
            exit 1
          fi

          # Docker build is conditional, so only fail if it ran and failed
          if [[ "${{ needs.docker-build-test.result }}" == "failure" ]]; then
            echo "::error::Docker build test failed"
            exit 1
          fi

          echo "âœ… All infrastructure CI checks passed!"
