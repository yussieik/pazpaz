name: Validate Secrets

on:
  workflow_dispatch:
    inputs:
      verbose:
        description: 'Enable verbose output'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
  schedule:
    - cron: '0 9 * * 1'  # Weekly on Mondays at 9 AM UTC

jobs:
  validate:
    name: Validate GitHub Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check critical secrets
        id: critical
        run: |
          MISSING=""

          # Critical PHI encryption
          if [ -z "${{ secrets.PROD_ENCRYPTION_MASTER_KEY }}" ]; then
            echo "❌ PROD_ENCRYPTION_MASTER_KEY is not set (CRITICAL)"
            MISSING="$MISSING PROD_ENCRYPTION_MASTER_KEY"
          else
            echo "✅ PROD_ENCRYPTION_MASTER_KEY configured"
          fi

          if [ -n "$MISSING" ]; then
            echo "::error::Critical secrets missing: $MISSING"
            exit 1
          fi

      - name: Check database secrets
        run: |
          MISSING=""

          if [ -z "${{ secrets.PROD_DATABASE_URL }}" ]; then
            echo "❌ PROD_DATABASE_URL not set"
            MISSING="$MISSING PROD_DATABASE_URL"
          fi

          if [ -z "${{ secrets.PROD_POSTGRES_PASSWORD }}" ]; then
            echo "❌ PROD_POSTGRES_PASSWORD not set"
            MISSING="$MISSING PROD_POSTGRES_PASSWORD"
          fi

          if [ -n "$MISSING" ]; then
            echo "::warning::Database secrets missing: $MISSING"
          fi

      - name: Check SSH secrets
        run: |
          MISSING=""

          for secret in SSH_PRIVATE_KEY SSH_HOST SSH_USER; do
            if [ -z "$(echo '${{ secrets }}' | jq -r .${secret})" ]; then
              echo "❌ ${secret} not set"
              MISSING="$MISSING $secret"
            fi
          done

          if [ -n "$MISSING" ]; then
            echo "::warning::SSH secrets missing: $MISSING"
          fi

      - name: Check application secrets
        run: |
          REQUIRED=(
            "PROD_SECRET_KEY"
            "PROD_JWT_SECRET_KEY"
            "PROD_CSRF_SECRET_KEY"
            "PROD_REDIS_PASSWORD"
          )

          for secret in "${REQUIRED[@]}"; do
            if [ -z "$(echo '${{ secrets }}' | jq -r .${secret})" ]; then
              echo "⚠️ ${secret} not set"
            else
              echo "✅ ${secret} configured"
            fi
          done

      - name: Test SSH connection
        if: success()
        continue-on-error: true
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST || secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER || secrets.SSH_USER }}
          port: ${{ secrets.SSH_PORT || secrets.SSH_PORT || 22 }}
          key: ${{ secrets.SSH_PRIVATE_KEY || secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "✅ SSH connection successful"
            docker --version || echo "⚠️ Docker not installed"
            docker compose version || echo "⚠️ Docker Compose not installed"

      - name: Generate summary
        if: always()
        run: |
          echo "## Secrets Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Validated at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
