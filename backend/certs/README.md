# PostgreSQL SSL/TLS Certificates

This directory contains SSL/TLS certificates for encrypting PostgreSQL database connections.

## HIPAA Compliance

**CRITICAL:** PostgreSQL SSL/TLS is **REQUIRED** for HIPAA compliance. All PHI (Protected Health Information) data transmitted between the application and database MUST be encrypted in transit.

## Files in this Directory

### Development (Self-Signed Certificates)

Generated by `./backend/scripts/generate_ssl_certs.sh`:

- `ca-cert.pem` - Certificate Authority (CA) certificate (used for verification)
- `ca-key.pem` - CA private key (keep secure)
- `server-cert.pem` - PostgreSQL server certificate
- `server-key.pem` - PostgreSQL server private key
- `client-cert.pem` - Client certificate (optional, for mutual TLS)
- `client-key.pem` - Client private key (optional, for mutual TLS)
- `root.crt` - Symlink to ca-cert.pem (PostgreSQL convention)

### Production (CA-Signed Certificates)

For production, use CA-signed certificates from:
- **AWS RDS:** Download from [AWS RDS Certificate Authority](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL.html)
- **Let's Encrypt:** Free CA-signed certificates
- **Your Organization's Internal CA**

## Security Notes

### File Permissions

PostgreSQL requires specific file permissions for SSL certificates:

```bash
chmod 600 server-key.pem client-key.pem ca-key.pem  # Private keys (owner read/write only)
chmod 644 server-cert.pem client-cert.pem ca-cert.pem  # Certificates (owner read/write, others read)
```

### .gitignore

All certificate files are automatically ignored by Git (via `.gitignore` patterns: `*.pem`, `*.key`). Never commit private keys to version control.

## Generating Certificates

### Development (Self-Signed)

```bash
./backend/scripts/generate_ssl_certs.sh
```

This generates self-signed certificates valid for 365 days. Suitable for local development only.

### Production (AWS RDS)

```bash
# Download AWS RDS CA certificate bundle
wget https://truststore.pki.rds.amazonaws.com/global/global-bundle.pem

# Move to system certificate store (Linux)
sudo mv global-bundle.pem /etc/ssl/certs/rds-ca-2019-root.pem

# Update .env for production
DB_SSL_MODE=verify-full
DB_SSL_CA_CERT_PATH=/etc/ssl/certs/rds-ca-2019-root.pem
```

## SSL Configuration Modes

PazPaz supports multiple SSL verification modes (configured via `DB_SSL_MODE`):

### `verify-full` (Production Recommended)
- **Security:** HIGHEST
- **Verifies:** Certificate AND hostname
- **Use case:** Production with CA-signed certificates
- **Requires:** CA certificate with valid hostname in CN/SAN

### `verify-ca` (Staging/Development)
- **Security:** HIGH
- **Verifies:** Certificate only (not hostname)
- **Use case:** Development with self-signed certificates
- **Requires:** CA certificate

### `require` (Development)
- **Security:** MEDIUM
- **Verifies:** Encryption only (no certificate verification)
- **Use case:** Development when certificate verification fails
- **Requires:** SSL enabled in PostgreSQL

### `disable` (HIPAA Violation)
- **Security:** NONE
- **Verifies:** Nothing
- **Use case:** NEVER use in production (HIPAA violation)
- **Warning:** Exposes PHI data in plaintext

## Testing SSL Connection

Verify SSL is working:

```bash
# Test from application
cd backend
PYTHONPATH=./src uv run python test_ssl_connection.py

# Test from PostgreSQL client
docker exec pazpaz-db psql -U pazpaz -d pazpaz -c "SHOW ssl;"

# Check SSL status of current connection
docker exec pazpaz-db psql -U pazpaz -d pazpaz -c "SELECT ssl, version FROM pg_stat_ssl WHERE pid = pg_backend_pid();"
```

Expected output:
```
ssl | version
----+---------
t   | TLSv1.3
```

## Troubleshooting

### "certificate verify failed: invalid CA certificate"

**Problem:** Self-signed certificate not trusted.

**Solution:** Use `DB_SSL_MODE=require` for development (encrypts but doesn't verify).

### "no pg_hba.conf entry for host ... SSL off"

**Problem:** PostgreSQL not configured to accept SSL connections.

**Solution:** Ensure docker-compose.yml mounts certificates and runs PostgreSQL with `ssl=on`.

### "Private key file ... has group or world access"

**Problem:** File permissions too open.

**Solution:**
```bash
cd backend/certs
chmod 600 *.key *.pem
```

### "could not access private key file: No such file or directory"

**Problem:** Certificates not generated or not mounted in container.

**Solution:**
```bash
./backend/scripts/generate_ssl_certs.sh
docker compose restart db
```

## Certificate Rotation

### Development

Self-signed certificates expire after 365 days. Regenerate:

```bash
cd backend
./scripts/generate_ssl_certs.sh
docker compose restart db
```

### Production

Follow your organization's certificate rotation policy. HIPAA recommends rotating encryption keys every 90 days, though SSL certificates typically have longer lifespans (1 year).

Set up certificate expiration monitoring:

```bash
# Check expiration date
openssl x509 -in server-cert.pem -noout -enddate

# Alert if certificate expires in <30 days
```

## References

- [PostgreSQL SSL Documentation](https://www.postgresql.org/docs/current/ssl-tcp.html)
- [AWS RDS SSL/TLS Guide](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/UsingWithRDS.SSL.html)
- [HIPAA Security Rule - Transmission Security](https://www.hhs.gov/hipaa/for-professionals/security/laws-regulations/index.html)
- [NIST Cryptographic Standards](https://csrc.nist.gov/projects/cryptographic-standards-and-guidelines)

## Support

For issues with SSL/TLS configuration, see:
- `/docs/SECURITY_REMEDIATION_PLAN.md` - Task 1.1
- `/docs/security/` - Security documentation
- PostgreSQL logs: `docker logs pazpaz-db`
